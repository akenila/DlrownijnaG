
def resource_path(relative_path):
    """Get absolute path to resource, works for dev and for PyInstaller"""
    try:
        base_path = sys._MEIPASS
    except Exception:
        base_path = os.path.abspath(".")
    return os.path.join(base_path, relative_path)
eel.init(resource_path("web"))
@eel.expose
def get_app_info():
    """Tráº£ vá» thÃ´ng tin á»©ng dá»¥ng"""
    return {
        "name": "GanSync Post Pro",
        "version": "1.0.0",
        "description": "Professional Content Sync Platform"
    }

@eel.expose
def test_connection(platform, credentials):
    """Test káº¿t ná»‘i Ä‘áº¿n platform"""
    try:
        # Simulate connection test
        import time
        time.sleep(2)
        return {
            "success": True,
            "message": f"Successfully connected to {platform}",
            "timestamp": time.time()
        }
    except Exception as e:
        return {
            "success": False,
            "message": str(e),
            "timestamp": time.time()
        }

@eel.expose
def scan_platform(platform, target_url, cookies=None):
    """Scan content tá»« platform"""
    try:
        # Simulate content scanning
        import time
        time.sleep(3)
        
        # Mock data
        mock_content = [
            {
                "id": f"{platform}_1",
                "title": f"Sample content from {platform}",
                "type": "post",
                "date": "2024-01-15",
                "likes": 150,
                "views": 1200
            },
            {
                "id": f"{platform}_2", 
                "title": f"Another post from {platform}",
                "type": "article",
                "date": "2024-01-14",
                "likes": 89,
                "views": 567
            }
        ]
        
        return {
            "success": True,
            "content": mock_content,
            "count": len(mock_content),
            "platform": platform
        }
    except Exception as e:
        return {
            "success": False,
            "message": str(e),
            "platform": platform
        }

@eel.expose
def save_workflow(workflow_data):
    """LÆ°u workflow configuration"""
    try:
        # Simulate saving workflow
        import json
        import time
        
        # Create SaveData directory if not exists
        save_dir = Path("SaveData")
        save_dir.mkdir(exist_ok=True)
        
        # Save workflow to file
        filename = f"workflow_{int(time.time())}.json"
        filepath = save_dir / filename
        
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(workflow_data, f, ensure_ascii=False, indent=2)
        
        return {
            "success": True,
            "message": f"Workflow saved to {filename}",
            "filepath": str(filepath)
        }
    except Exception as e:
        return {
            "success": False,
            "message": str(e)
        }

@eel.expose
def load_workflow(filename):
    """Load workflow tá»« file"""
    try:
        import json
        
        filepath = Path("SaveData") / filename
        if not filepath.exists():
            return {
                "success": False,
                "message": "Workflow file not found"
            }
        
        with open(filepath, 'r', encoding='utf-8') as f:
            workflow_data = json.load(f)
        
        return {
            "success": True,
            "workflow": workflow_data
        }
    except Exception as e:
        return {
            "success": False,
            "message": str(e)
        }

@eel.expose
def get_saved_workflows():
    """Láº¥y danh sÃ¡ch workflow Ä‘Ã£ lÆ°u"""
    try:
        save_dir = Path("SaveData")
        if not save_dir.exists():
            return {"workflows": []}
        
        workflows = []
        for file in save_dir.glob("workflow_*.json"):
            workflows.append({
                "filename": file.name,
                "size": file.stat().st_size,
                "modified": file.stat().st_mtime
            })
        
        return {"workflows": workflows}
    except Exception as e:
        return {
            "success": False,
            "message": str(e)
        }

@eel.expose
def login_ganjing_node(email, password, node_id):
    """Login vÃ o GanJing World cho node cá»¥ thá»ƒ"""
    try:
        print(f"ğŸ”‘ Attempting login for node {node_id} with email: {email}")
        
        # Sá»­ dá»¥ng function tá»« Function.py
        access_token = login_ganjingworld(email, password)
        
        if access_token:
            print(f"âœ… Login successful for node {node_id}")
            return {
                "success": True,
                "message": "ÄÄƒng nháº­p thÃ nh cÃ´ng!",
                "access_token": access_token,  # Tráº£ vá» token Ä‘áº§y Ä‘á»§
                "status": "success"
            }
        else:
            print(f"âŒ Login failed for node {node_id}")
            return {
                "success": False,
                "message": "Email khÃ´ng tá»“n táº¡i hoáº·c máº­t kháº©u sai",
                "status": "failed"
            }
            
    except Exception as e:
        print(f"âŒ Login error for node {node_id}: {e}")
        return {
            "success": False,
            "message": f"Lá»—i Ä‘Äƒng nháº­p: {str(e)}",
            "status": "error"
        }

@eel.expose
def convert_facebook_cookies_to_token(cookies, node_id):
    """Chuyá»ƒn Facebook cookies thÃ nh access token"""
    try:
        print(f"ğŸª Converting Facebook cookies to token for node {node_id}")
        
        # Import function tá»« Function.py
        from Function import EAAGNO
        
        # Chuyá»ƒn cookies thÃ nh token
        access_token = EAAGNO(cookies)
        
        if access_token:
            print(f"âœ… Token conversion successful for node {node_id}")
            return {
                "success": True,
                "message": "Chuyá»ƒn Ä‘á»•i cookies thÃ nh cÃ´ng!",
                "access_token": access_token,
                "status": "success"
            }
        else:
            print(f"âŒ Token conversion failed for node {node_id}")
            return {
                "success": False,
                "message": "KhÃ´ng thá»ƒ chuyá»ƒn Ä‘á»•i cookies thÃ nh token",
                "status": "failed"
            }
            
    except Exception as e:
        print(f"âŒ Token conversion error for node {node_id}: {e}")
        return {
            "success": False,
            "message": f"Lá»—i chuyá»ƒn Ä‘á»•i: {str(e)}",
            "status": "error"
        }

@eel.expose
def scan_facebook_content(page_url, num_posts, access_token, cookies, node_id):
    """QuÃ©t ná»™i dung tá»« Facebook page"""
    try:
        print(f"ğŸ“± Scanning Facebook content for node {node_id}")
        print(f"URL: {page_url}, Posts: {num_posts}")
        
        # Import function tá»« Function.py
        from Function import get_facebook_content
        
        # QuÃ©t ná»™i dung tá»« Facebook
        content_list = get_facebook_content(page_url, num_posts, access_token, cookies)
        
        if content_list and len(content_list) > 0:
            print(f"âœ… Found {len(content_list)} posts for node {node_id}")
            
            # Format content for frontend
            formatted_content = []
            for i, content_item in enumerate(content_list):
                text_content = content_item[0] if content_item[0] else "No text content"
                image_path = content_item[1] if content_item[1] else None
                
                formatted_content.append({
                    "id": f"fb_{node_id}_{i}",
                    "title": text_content[:100] + "..." if len(text_content) > 100 else text_content,
                    "content": text_content,
                    "image": image_path,
                    "type": "post",
                    "platform": "facebook",
                    "date": "2024-01-15",  # Mock date
                    "likes": 0,
                    "views": 0,
                    "selected": False
                })
            
            return {
                "success": True,
                "message": f"QuÃ©t thÃ nh cÃ´ng {len(formatted_content)} bÃ i viáº¿t",
                "content": formatted_content,
                "count": len(formatted_content)
            }
        else:
            print(f"âŒ No content found for node {node_id}")
            return {
                "success": False,
                "message": "KhÃ´ng tÃ¬m tháº¥y bÃ i viáº¿t nÃ o",
                "content": [],
                "count": 0
            }
            
    except Exception as e:
        print(f"âŒ Facebook scan error for node {node_id}: {e}")
        return {
            "success": False,
            "message": f"Lá»—i quÃ©t ná»™i dung: {str(e)}",
            "content": [],
            "count": 0
        }

@eel.expose
def post_to_ganjing(access_token, content, image_path, node_id):
    """ÄÄƒng bÃ i lÃªn GanJing World"""
    try:
        print(f"ğŸ“ Posting to GanJing World for node {node_id}")
        
        # Validate input parameters
        if not access_token:
            print(f"âŒ Missing access token for node {node_id}")
            return {
                "success": False,
                "message": "Thiáº¿u access token",
                "status": "error"
            }
        
        if not content:
            print(f"âŒ Missing content for node {node_id}")
            return {
                "success": False,
                "message": "Thiáº¿u ná»™i dung bÃ i viáº¿t",
                "status": "error"
            }
        
        # Safe content preview
        content_preview = str(content)[:100] + "..." if len(str(content)) > 100 else str(content)
        print(f"Content: {content_preview}")
        print(f"Image: {image_path or 'None'}")
        
        # Import function tá»« Function.py
        from Function import post_content
        
        # ÄÄƒng bÃ i lÃªn GanJing World
        post_id = post_content(access_token, content, image_path)
        
        if post_id:
            print(f"âœ… Successfully posted to GanJing World for node {node_id}")
            return {
                "success": True,
                "message": "ÄÄƒng bÃ i thÃ nh cÃ´ng!",
                "post_id": post_id,
                "status": "success"
            }
        else:
            print(f"âŒ Failed to post to GanJing World for node {node_id}")
            return {
                "success": False,
                "message": "KhÃ´ng thá»ƒ Ä‘Äƒng bÃ i lÃªn GanJing World",
                "status": "failed"
            }
            
    except Exception as e:
        print(f"âŒ Error posting to GanJing World for node {node_id}: {e}")
        import traceback
        traceback.print_exc()  # Print full error traceback
        return {
            "success": False,
            "message": f"Lá»—i Ä‘Äƒng bÃ i: {str(e)}",
            "status": "error"
        }

def main():
    """Main function Ä‘á»ƒ cháº¡y á»©ng dá»¥ng"""
    try:
        # Kiá»ƒm tra file HTML tá»“n táº¡i
        html_file = Path("web/post.html")
        if not html_file.exists():
            print("âŒ Error: post.html not found in web/ directory")
            print("Please make sure post.html is in the web/ folder")
            return
        
        print("ğŸš€ Starting GanSync Post Pro...")
        print("ğŸ“± Opening as desktop application...")
        
        # Cáº¥u hÃ¬nh Eel
        options = {
            'mode': 'chrome',  # Sá»­ dá»¥ng Chrome
            'port': 8080,
            'chrome_cmd_args': [
                '--start-maximized',  # Má»Ÿ cá»­a sá»• full size
                '--disable-web-security',  # Disable CORS cho development
                '--disable-features=VizDisplayCompositor'
            ]
        }
        
        # Khá»Ÿi Ä‘á»™ng á»©ng dá»¥ng
        eel.start('post.html', 
                  size=(1400, 900), port=8080)
                  
    except Exception as e:
        print(f"âŒ Error starting application: {e}")
        print("Make sure you have Chrome browser installed")

main()
